"0","EnKF <- function(y, mu_1, Q_1, A, Q_t, R_t, ensemble_size) {"
"0","  start.time <- Sys.time()"
"0","  # Initialize"
"0","  set.seed(10)"
"0","  ensemble <- list()"
"0","  mu <- matrix(NA, nrow(y), 4)"
"0","  Sigma <- list()"
"0","  "
"0","  ensemble[[1]] <- list()"
"0","  ensemble[[1]]$mu_tilde <- matrix(NA, ensemble_size, 4)"
"0","  for (i in 1:ensemble_size) {"
"0","    ensemble[[1]]$mu_tilde[i,] <- mvrnorm(1, A %*% mu_1, Q_1)"
"0","  }"
"0","  ensemble[[1]]$y <- matrix(NA, ensemble_size, 2)"
"0","  for (i in 1:ensemble_size) {"
"0","    ensemble[[1]]$y[i,] <- mvrnorm(1, h(ensemble[[1]]$mu_tilde[i,]), R_t)"
"0","  }"
"0","  ensemble[[1]]$Sigma_y <- 0"
"0","  for (i in 1:ensemble_size) {"
"0","    ensemble[[1]]$Sigma_y <- ensemble[[1]]$Sigma_y + (ensemble[[1]]$y[i,] - colMeans(ensemble[[1]]$y)) %*% t(ensemble[[1]]$y[i,] - colMeans(ensemble[[1]]$y))"
"0","  }"
"0","  ensemble[[1]]$Sigma_y <- ensemble[[1]]$Sigma_y / ensemble_size"
"0","  ensemble[[1]]$Sigma_xy <- 0"
"0","  for (i in 1:ensemble_size) {"
"0","    ensemble[[1]]$Sigma_xy <- ensemble[[1]]$Sigma_xy + (ensemble[[1]]$mu_tilde[i,] - colMeans(ensemble[[1]]$mu_tilde)) %*% t(ensemble[[1]]$y[i,] - colMeans(ensemble[[1]]$y))"
"0","  }"
"0","  ensemble[[1]]$Sigma_xy <- ensemble[[1]]$Sigma_xy / ensemble_size"
"0","  ensemble[[1]]$K <- ensemble[[1]]$Sigma_xy %*% solve(ensemble[[1]]$Sigma_y)"
"0","  ensemble[[1]]$mu_hat <- matrix(NA, ensemble_size, 4)"
"0","  for (i in 1:ensemble_size) {"
"0","    ensemble[[1]]$mu_hat[i,] <- ensemble[[1]]$mu_tilde[i,] + ensemble[[1]]$K %*% (y[1,] - ensemble[[1]]$y[i,])"
"0","  }"
"0","  mu[1,] <- apply(ensemble[[1]]$mu_hat, 2, median)"
"0","  Sigma[[1]] <- cov(ensemble[[1]]$mu_hat)"
"0","  "
"0","  for (i in 2:nrow(y)) {"
"0","    ensemble[[i]] <- list()"
"0","    ensemble[[i]]$mu_tilde <- matrix(NA, ensemble_size, 4)"
"0","    for (j in 1:ensemble_size) {"
"0","      ensemble[[i]]$mu_tilde[j,] <- mvrnorm(1, A %*% ensemble[[i - 1]]$mu_hat[j,], Q_t)"
"0","    }"
"0","    ensemble[[i]]$y <- matrix(NA, ensemble_size, 2)"
"0","    for (j in 1:ensemble_size) {"
"0","      ensemble[[i]]$y[j,] <- mvrnorm(1, h(ensemble[[i]]$mu_tilde[j,]), R_t)"
"0","    }"
"0","    ensemble[[i]]$Sigma_y <- 0"
"0","    for (j in 1:ensemble_size) {"
"0","      ensemble[[i]]$Sigma_y <- ensemble[[i]]$Sigma_y + (ensemble[[i]]$y[j,] - colMeans(ensemble[[i]]$y)) %*% t(ensemble[[i]]$y[j,] - colMeans(ensemble[[i]]$y))"
"0","    }"
"0","    ensemble[[i]]$Sigma_y <- ensemble[[i]]$Sigma_y / ensemble_size"
"0","    ensemble[[i]]$Sigma_xy <- 0"
"0","    for (j in 1:ensemble_size) {"
"0","      ensemble[[i]]$Sigma_xy <- ensemble[[i]]$Sigma_xy + (ensemble[[i]]$mu_tilde[j,] - colMeans(ensemble[[i]]$mu_tilde)) %*% t(ensemble[[i]]$y[j,] - colMeans(ensemble[[i]]$y))"
"0","    }"
"0","    ensemble[[i]]$Sigma_xy <- ensemble[[i]]$Sigma_xy / ensemble_size"
"0","    ensemble[[i]]$K <- ensemble[[i]]$Sigma_xy %*% solve(ensemble[[i]]$Sigma_y)"
"0","    ensemble[[i]]$mu_hat <- matrix(NA, ensemble_size, 4)"
"0","    for (j in 1:ensemble_size) {"
"0","      ensemble[[i]]$mu_hat[j,] <- ensemble[[i]]$mu_tilde[j,] + ensemble[[i]]$K %*% (y[i,] - ensemble[[i]]$y[j,])"
"0","    }"
"0","    mu[i,] <- apply(ensemble[[i]]$mu_hat, 2, median)"
"0","    Sigma[[i]] <- cov(ensemble[[i]]$mu_hat)"
"0","  }"
"0","  end.time <- Sys.time()"
"0","  time.taken <- end.time - start.time"
"0","  return(list(mu = mu, Sigma = Sigma, time = time.taken))"
"0","}"
"0",""
"0","EnKF_mu_Sigma_ensemble_1000 <- EnKF(sensor, mu_1, Q_1, A, Q_t, R_t, 1000)"
"0",""
"0","EnKF_mu_Sigma_ensemble_1000_plot <- plot_est_fun(EnKF_mu_Sigma_ensemble_1000)"
"0","EnKF_mu_Sigma_ensemble_1000_plot"
